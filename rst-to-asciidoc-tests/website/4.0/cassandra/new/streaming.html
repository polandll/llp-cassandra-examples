<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Improved Streaming :: Apache Cassandra Documentation</title>
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Apache Cassandra Documentation&nbsp;&nbsp;&nbsp;<img src="../../../../_/img/cassandra_logo.png"></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Developer Mailing List</a>
            <a class="navbar-item" href="#">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ASCIIDOC_POC" data-version="4.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">ASCIIDOC_POC</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Cassandra Documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">What&#8217;s new</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../data_modeling/index.html">Data Modeling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/appendices.html">Appendices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/index.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operating/index.html">Operating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools/index.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/index.html">Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/index.html">Plug-ins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../faq/index.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ASCIIDOC_POC</span>
    <span class="version">4.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ASCIIDOC_POC</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">ASCIIDOC_POC</a></li>
    <li><a href="streaming.html">Improved Streaming</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/new/streaming.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Improved Streaming</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Apache Cassandra 4.0 has made several improvements to streaming.
Streaming is the process used by nodes of a cluster to exchange data in
the form of SSTables. Streaming of SSTables is performed for several
operations, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SSTable Repair</p>
</li>
<li>
<p>Host Replacement</p>
</li>
<li>
<p>Range movements</p>
</li>
<li>
<p>Bootstrapping</p>
</li>
<li>
<p>Rebuild</p>
</li>
<li>
<p>Cluster expansion</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="streaming-based-on-netty"><a class="anchor" href="#streaming-based-on-netty"></a>Streaming based on Netty</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Streaming in Cassandra 4.0 is based on Non-blocking Input/Output (NIO)
with Netty
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-12229">CASSANDRA-12229</a>).
It replaces the single-threaded (or sequential), synchronous, blocking
model of streaming messages and transfer of files. Netty supports
non-blocking, asynchronous, multi-threaded streaming with which multiple
connections are opened simultaneously. Non-blocking implies that threads
are not blocked as they don’t wait for a response for a sent request. A
response could be returned in a different thread. With asynchronous,
connections and threads are decoupled and do not have a 1:1 relation.
Several more connections than threads may be opened.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="zero-copy-streaming"><a class="anchor" href="#zero-copy-streaming"></a>Zero Copy Streaming</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pre-4.0, during streaming Cassandra reifies the SSTables into objects.
This creates unnecessary garbage and slows down the whole streaming
process as some SSTables can be transferred as a whole file rather than
individual partitions. Cassandra 4.0 has added support for streaming
entire SSTables when possible
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-14556">CASSANDRA-14556</a>)
for faster Streaming using ZeroCopy APIs. If enabled, Cassandra will use
ZeroCopy for eligible SSTables significantly speeding up transfers and
increasing throughput. A zero-copy path avoids bringing data into
user-space on both sending and receiving side. Any streaming related
operations will notice corresponding improvement. Zero copy streaming is
hardware bound; only limited by the hardware limitations (Network and
Disk IO ).</p>
</div>
<div class="sect2">
<h3 id="high-availability"><a class="anchor" href="#high-availability"></a>High Availability</h3>
<div class="paragraph">
<p>In benchmark tests Zero Copy Streaming is 5x faster than partitions
based streaming. Faster streaming provides the benefit of improved
availability. A cluster’s recovery mainly depends on the streaming
speed, Cassandra clusters with failed nodes will be able to recover much
more quickly (5x faster). If a node fails, SSTables need to be streamed
to a replacement node. During the replacement operation, the new
Cassandra node streams SSTables from the neighboring nodes that hold
copies of the data belonging to this new node’s token range. Depending
on the amount of data stored, this process can require substantial
network bandwidth, taking some time to complete. The longer these range
movement operations take, the more the cluster availability is lost.
Failure of multiple nodes would reduce high availability greatly. The
faster the new node completes streaming its data, the faster it can
serve traffic, increasing the availability of the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="enabling-zero-copy-streaming"><a class="anchor" href="#enabling-zero-copy-streaming"></a>Enabling Zero Copy Streaming</h3>
<div class="paragraph">
<p>Zero copy streaming is enabled by setting the following setting in
<code>cassandra.yaml</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>stream_entire_sstables: true</pre>
</div>
</div>
<div class="paragraph">
<p>By default zero copy streaming is enabled.</p>
</div>
</div>
<div class="sect2">
<h3 id="sstables-eligible-for-zero-copy-streaming"><a class="anchor" href="#sstables-eligible-for-zero-copy-streaming"></a>SSTables Eligible for Zero Copy Streaming</h3>
<div class="paragraph">
<p>Zero copy streaming is used if all partitions within the SSTable need to
be transmitted. This is common when using <code>LeveledCompactionStrategy</code> or
when partitioning SSTables by token range has been enabled. All
partition keys in the SSTables are iterated over to determine the
eligibility for Zero Copy streaming.</p>
</div>
</div>
<div class="sect2">
<h3 id="benefits-of-zero-copy-streaming"><a class="anchor" href="#benefits-of-zero-copy-streaming"></a>Benefits of Zero Copy Streaming</h3>
<div class="paragraph">
<p>When enabled, it permits Cassandra to zero-copy stream entire eligible
SSTables between nodes, including every component. This speeds up the
network transfer significantly subject to throttling specified by
<code>stream_throughput_outbound_megabits_per_sec</code>.</p>
</div>
<div class="paragraph">
<p>Enabling this will reduce the GC pressure on sending and receiving node.
While this feature tries to keep the disks balanced, it cannot guarantee
it. This feature will be automatically disabled if internode encryption
is enabled. Currently this can be used with Leveled Compaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-for-zero-copy-streaming"><a class="anchor" href="#configuring-for-zero-copy-streaming"></a>Configuring for Zero Copy Streaming</h3>
<div class="paragraph">
<p>Throttling would reduce the streaming speed. The
<code>stream_throughput_outbound_megabits_per_sec</code> throttles all outbound
streaming file transfers on a node to the given total throughput in
Mbps. When unset, the default is 200 Mbps or 25 MB/s.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>stream_throughput_outbound_megabits_per_sec: 200</pre>
</div>
</div>
<div class="paragraph">
<p>To run any Zero Copy streaming benchmark the
<code>stream_throughput_outbound_megabits_per_sec</code> must be set to a really
high value otherwise, throttling will be significant and the benchmark
results will not be meaningful.</p>
</div>
<div class="paragraph">
<p>The <code>inter_dc_stream_throughput_outbound_megabits_per_sec</code> throttles all
streaming file transfer between the datacenters, this setting allows
users to throttle inter dc stream throughput in addition to throttling
all network stream traffic as configured with
<code>stream_throughput_outbound_megabits_per_sec</code>. When unset, the default
is 200 Mbps or 25 MB/s.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>inter_dc_stream_throughput_outbound_megabits_per_sec: 200</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sstable-components-streamed-with-zero-copy-streaming"><a class="anchor" href="#sstable-components-streamed-with-zero-copy-streaming"></a>SSTable Components Streamed with Zero Copy Streaming</h3>
<div class="paragraph">
<p>Zero Copy Streaming streams entire SSTables. SSTables are made up of
multiple components in separate files. SSTable components streamed are
listed in Table 1.</p>
</div>
<div class="paragraph">
<p>Table 1. SSTable Components</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 98%;">
<colgroup>
<col style="width: 27%;">
<col style="width: 73%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SSTable Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The base data for an SSTable: the remaining components can be
regenerated based on the data component.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index of the row keys with pointers to their positions in the
data file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Filter.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serialized bloom filter for the row keys in the SSTable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CompressionInfo.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File to hold information about uncompressed data
length, chunk offsets etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Statistics.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Statistical metadata about the content of the SSTable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Digest.crc32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds CRC32 checksum of the data file size_bytes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CRC.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the CRC32 for chunks in an uncompressed file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Summary.db</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds SSTable Index Summary (sampling of Index component)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TOC.txt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Table of contents, stores the list of all components for the
SSTable.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Custom component, used by e.g. custom compaction strategy may also be
included.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repair-streaming-preview"><a class="anchor" href="#repair-streaming-preview"></a>Repair Streaming Preview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Repair with <code>nodetool repair</code> involves streaming of repaired SSTables
and a repair preview has been added to provide an estimate of the amount
of repair streaming that would need to be performed. Repair preview
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-13257">CASSANDRA-13257</a>)
is invoke with <code>nodetool repair --preview</code> using option:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>-prv, --preview</pre>
</div>
</div>
<div class="paragraph">
<p>It determines ranges and amount of data to be streamed, but doesn&#8217;t
actually perform repair.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parallelizing-of-streaming-of-keyspaces"><a class="anchor" href="#parallelizing-of-streaming-of-keyspaces"></a>Parallelizing of Streaming of Keyspaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The streaming of the different keyspaces for bootstrap and rebuild has
been parallelized in Cassandra 4.0
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-4663">CASSANDRA-4663</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="unique-nodes-for-streaming-in-multi-dc-deployment"><a class="anchor" href="#unique-nodes-for-streaming-in-multi-dc-deployment"></a>Unique nodes for Streaming in Multi-DC deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Range Streamer picks unique nodes to stream data from when number of
replicas in each DC is three or more
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-4650">CASSANDRA-4650</a>).
What the optimization does is to even out the streaming load across the
cluster. Without the optimization, some node can be picked up to stream
more data than others. This patch allows to select dedicated node to
stream only one range.</p>
</div>
<div class="paragraph">
<p>This will increase the performance of bootstrapping a node and will also
put less pressure on nodes serving the data. This does not affect if N &lt;
3 in each DC as then it streams data from only 2 nodes.</p>
</div>
<div class="paragraph">
<p>Stream Operation Types <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>^</p>
</div>
<div class="paragraph">
<p>It is important to know the type or purpose of a certain stream. Version
4.0
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-13064">CASSANDRA-13064</a>)
adds an <code>enum</code> to distinguish between the different types of streams.
Stream types are available both in a stream request and a stream task.
The different stream types are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restore replica count</p>
</li>
<li>
<p>Unbootstrap</p>
</li>
<li>
<p>Relocation</p>
</li>
<li>
<p>Bootstrap</p>
</li>
<li>
<p>Rebuild</p>
</li>
<li>
<p>Bulk Load</p>
</li>
<li>
<p>Repair</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disallow-decommission-when-number-of-replicas-will-drop-below-configured-rf"><a class="anchor" href="#disallow-decommission-when-number-of-replicas-will-drop-below-configured-rf"></a>Disallow Decommission when number of Replicas will drop below configured RF</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://issues.apache.org/jira/browse/CASSANDRA-12510">CASSANDRA-12510</a>
guards against decommission that will drop # of replicas below
configured replication factor (RF), and adds the <code>--force</code> option that
allows decommission to continue if intentional; force decommission of
this node even when it reduces the number of replicas to below
configured RF.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
